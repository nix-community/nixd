<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>nixd: Configuration</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">nixd
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Configuration </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md13"></a></p>
<p>We support LSP standard <span class="tt">workspace/configuration</span> for server configurations.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md14"></a>
Default configuration &amp; Who needs configuration</h2>
<p>Most important part of package/options features is the path of "nixpkgs". By default, this is search via standard nix search path. That is, find nixpkgs via <span class="tt">&lt;nixpkgs&gt;</span>.</p>
<p>For nix-channels users: nixos option &amp; package features shall work out of box, without any extra effort.</p>
<p>For nix-flake users: (suggestion) you can set $NIX_PATH env to your flake input. e.g.</p>
<div class="fragment"><div class="line">{ inputs, ... }:</div>
<div class="line">{</div>
<div class="line">  # NixOS configuration.</div>
<div class="line">  nix.nixPath = [ &quot;nixpkgs=${inputs.nixpkgs}&quot; ];</div>
<div class="line">}</div>
</div><!-- fragment --><p>If you do not config anything in nixd, here are the defaults (suitable for most nix newbies).</p>
<ul>
<li>nixpkgs packages comes from <span class="tt">import &lt;nixpkgs&gt; { }</span></li>
<li>nixos options, evaluated from <span class="tt">&lt;nixpkgs&gt;</span></li>
</ul>
<p>For advanced users, e.g. having many custom modules, or want to extend anyother options system, "options" field must be extended in the settings, to tell nixd how to get the modules. tldr:</p>
<ul>
<li>custom module system (home-manager, nix-darwin, flake-parts, ...)</li>
<li>custom nixpkgs path, input from your "system" flake</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md15"></a>
Where to place the configuration</h2>
<blockquote class="doxtable">
<p>In legacy versions (v1.x), configurations are written in ".nixd.json", please remove them and nixd won't even read such files anymore. </p>
</blockquote>
<p>All configuration should go in <span class="tt">nixd</span> section. <span class="tt">nixd</span> accept language server protocol specified <span class="tt">workspace/configuration</span> to fetch config file. So the location of configuration file basically determined by your editor setup.</p>
<blockquote class="doxtable">
<p>Please extend this list for your editor, thanks! </p>
</blockquote>
<details >
<summary >
VSCode</summary>
<p></p>
<p>For vscode users you should write <span class="tt">settings.json</span>[^settings] like this:</p>
<p>[^settings]: the file could be applied per-workspace, i.e. <span class="tt">.vscode/settings.json</span>, our globally, remotely. VSCode users should familiar with <a href="https://code.visualstudio.com/docs/getstarted/settings">these locations</a>.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;nix.serverSettings&quot;: {</div>
<div class="line">        // settings for &#39;nixd&#39; LSP</div>
<div class="line">        &quot;nixd&quot;: {</div>
<div class="line">            &quot;formatting&quot;: {</div>
<div class="line">              // ...</div>
<div class="line">            },</div>
<div class="line">            &quot;options&quot;: {</div>
<div class="line">              // ...</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p></p>
</details>
<details >
<summary >
Neovim</summary>
<p></p>
<p>Configuration via <a href="https://github.com/neovim/nvim-lspconfig">nvim-lspconfig</a> plugin. If you want to make configuration changes based on different projects, you can see nvim-lspconfig official <a href="https://github.com/neovim/nvim-lspconfig/wiki/Project-local-settings">wiki-Project_local_settings</a></p>
<div class="fragment"><div class="line">local nvim_lsp = require(&quot;lspconfig&quot;)</div>
<div class="line">nvim_lsp.nixd.setup({</div>
<div class="line">   cmd = { &quot;nixd&quot; },</div>
<div class="line">   settings = {</div>
<div class="line">      nixd = {</div>
<div class="line">         nixpkgs = {</div>
<div class="line">            expr = &quot;import &lt;nixpkgs&gt; { }&quot;,</div>
<div class="line">         },</div>
<div class="line">         formatting = {</div>
<div class="line">            command = { &quot;nixfmt&quot; },</div>
<div class="line">         },</div>
<div class="line">         options = {</div>
<div class="line">            nixos = {</div>
<div class="line">               expr = &#39;(builtins.getFlake (&quot;git+file://&quot; + toString ./.)).nixosConfigurations.k-on.options&#39;,</div>
<div class="line">            },</div>
<div class="line">            home_manager = {</div>
<div class="line">               expr = &#39;(builtins.getFlake (&quot;git+file://&quot; + toString ./.)).homeConfigurations.&quot;ruixi@k-on&quot;.options&#39;,</div>
<div class="line">            },</div>
<div class="line">         },</div>
<div class="line">      },</div>
<div class="line">   },</div>
<div class="line">})</div>
</div><!-- fragment --> </details>
<details >
<summary >
Emacs</summary>
<p></p>
<p>Configuration via <a href="https://github.com/emacs-lsp/lsp-mode">lsp-mode</a> plugin. As of Oct 24, 2024, lsp-mode master has support for nixd autocompletion and formatting options.</p>
<div class="fragment"><div class="line">(use-package nix-mode</div>
<div class="line">  :after lsp-mode</div>
<div class="line">  :ensure t</div>
<div class="line">  :hook</div>
<div class="line">  (nix-mode . lsp-deferred) ;; So that envrc mode will work</div>
<div class="line">  :custom</div>
<div class="line">  (lsp-disabled-clients &#39;((nix-mode . nix-nil))) ;; Disable nil so that nixd will be used as lsp-server</div>
<div class="line">  :config</div>
<div class="line">  (setq lsp-nix-nixd-server-path &quot;nixd&quot;</div>
<div class="line">        lsp-nix-nixd-formatting-command [ &quot;nixfmt&quot; ]</div>
<div class="line">        lsp-nix-nixd-nixpkgs-expr &quot;import &lt;nixpkgs&gt; { }&quot;</div>
<div class="line">        lsp-nix-nixd-nixos-options-expr &quot;(builtins.getFlake \&quot;/home/nb/nixos\&quot;).nixosConfigurations.mnd.options&quot;</div>
<div class="line">        lsp-nix-nixd-home-manager-options-expr &quot;(builtins.getFlake \&quot;/home/nb/nixos\&quot;).homeConfigurations.\&quot;nb@mnd\&quot;.options&quot;))</div>
<div class="line"> </div>
<div class="line">(add-hook! &#39;nix-mode-hook</div>
<div class="line">           ;; enable autocompletion with company</div>
<div class="line">           (setq company-idle-delay 0.1))</div>
</div><!-- fragment --> </details>
<h2 class="doxsection"><a class="anchor" id="autotoc_md16"></a>
Configuration overview</h2>
<dl class="section note"><dt>Note</dt><dd>This annotated json are under the key "nixd". If you don't know what does exactly this mean please see editor examples above.</dd></dl>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;nixpkgs&quot;: {</div>
<div class="line">    // For flake.</div>
<div class="line">    // &quot;expr&quot;: &quot;import (builtins.getFlake \&quot;/home/lyc/workspace/CS/OS/NixOS/flakes\&quot;).inputs.nixpkgs { }   &quot;</div>
<div class="line"> </div>
<div class="line">    // This expression will be interpreted as &quot;nixpkgs&quot; toplevel</div>
<div class="line">    // Nixd provides package, lib completion/information from it.</div>
<div class="line">    ///</div>
<div class="line">    // Resource Usage: Entries are lazily evaluated, entire nixpkgs takes 200~300MB for just &quot;names&quot;.</div>
<div class="line">    ///                Package documentation, versions, are evaluated by-need.</div>
<div class="line">    &quot;expr&quot;: &quot;import &lt;nixpkgs&gt; { }&quot;</div>
<div class="line">  },</div>
<div class="line">  &quot;formatting&quot;: {</div>
<div class="line">    // Which command you would like to do formatting</div>
<div class="line">    &quot;command&quot;: [ &quot;nixfmt&quot; ]</div>
<div class="line">  },</div>
<div class="line">  // Tell the language server your desired option set, for completion</div>
<div class="line">  // This is lazily evaluated.</div>
<div class="line">  &quot;options&quot;: { // Map of eval information</div>
<div class="line">      // By default, this entriy will be read from `import &lt;nixpkgs&gt; { }`</div>
<div class="line">      // You can write arbitary nix expression here, to produce valid &quot;options&quot; declaration result.</div>
<div class="line">      //</div>
<div class="line">      // *NOTE*: Replace &quot;&lt;name&gt;&quot; below with your actual configuration name.</div>
<div class="line">      // If you&#39;re unsure what to use, you can verify with `nix repl` by evaluating</div>
<div class="line">      // the expression directly.</div>
<div class="line">      //</div>
<div class="line">      &quot;nixos&quot;: {</div>
<div class="line">          &quot;expr&quot;: &quot;(builtins.getFlake (builtins.toString ./.)).nixosConfigurations.&lt;name&gt;.options&quot;</div>
<div class="line">      },</div>
<div class="line"> </div>
<div class="line">    // Before configuring Home Manager options, consider your setup:</div>
<div class="line">    // Which command do you use for home-manager switching?</div>
<div class="line">    //</div>
<div class="line">    //  A. home-manager switch --flake .#... (standalone Home Manager)</div>
<div class="line">    //  B. nixos-rebuild switch --flake .#... (NixOS with integrated Home Manager)</div>
<div class="line">    //</div>
<div class="line">    // Configuration examples for both approaches are shown below.</div>
<div class="line">    &quot;home-manager&quot;: {</div>
<div class="line">      // A:</div>
<div class="line">      &quot;expr&quot;: &quot;(builtins.getFlake (builtins.toString ./.)).homeConfigurations.&lt;name&gt;.options&quot;</div>
<div class="line"> </div>
<div class="line">      // B:</div>
<div class="line">      &quot;expr&quot;: &quot;(builtins.getFlake (builtins.toString ./.)).nixosConfigurations.&lt;name&gt;.options.home-manager.users.type.getSubOptions []&quot;</div>
<div class="line">    }</div>
<div class="line">  },</div>
<div class="line">  // Control the diagnostic system</div>
<div class="line">  &quot;diagnostic&quot;: {</div>
<div class="line">    &quot;suppress&quot;: [</div>
<div class="line">      &quot;sema-extra-with&quot;</div>
<div class="line">    ]</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md17"></a>
Fields explanation</h2>
<h3 class="doxsection"><a class="anchor" id="autotoc_md18"></a>
Diagnostic Control ("diagnostic")</h3>
<p>Some users might feel confident in their understanding of the language and prefer to suppress diagnostics altogether. This can be achieved by utilizing the diagnostic field.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;diagnostic&quot;: {</div>
<div class="line">    // A list of diagnostic short names</div>
<div class="line">    &quot;suppress&quot;: [</div>
<div class="line">      &quot;sema-extra-with&quot;</div>
<div class="line">    ]</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h3 class="doxsection"><a class="anchor" id="autotoc_md19"></a>
Format ("formating")</h3>
<p>To configure which command will be used for formatting, you can change the "formatting" section.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;formatting&quot;: {</div>
<div class="line">    // The external command to be invoked for formatting</div>
<div class="line">    &quot;command&quot;: [ &quot;some-command&quot; ]</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h3 class="doxsection"><a class="anchor" id="autotoc_md20"></a>
Options ("options")</h3>
<p>This is our support for nixpkgs option system.</p>
<p>Generally options are merged under a special attribute path. For example, NixOS options could be found at:</p>
<div class="fragment"><div class="line">&lt;flakeref&gt;#nixosConfigurations.&lt;name&gt;.options</div>
</div><!-- fragment --><p>And, home-manager options also could be found at:</p>
<div class="fragment"><div class="line">&lt;flakeref&gt;#homeConfigurations.&lt;name&gt;.options</div>
</div><!-- fragment --><p>In our option system, you need to specify which option set you'd like to use.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  // Tell the language server your desired option set, for completion</div>
<div class="line">  // This is lazily evaluated.</div>
<div class="line">  &quot;options&quot;: { // Map of eval information</div>
<div class="line">    // If this is ommited, default search path (&lt;nixpkgs&gt;) will be used.</div>
<div class="line">    &quot;nixos&quot;: { // This name &quot;nixos&quot; could be arbitary.</div>
<div class="line">      // The expression to eval, intepret it as option declarations.</div>
<div class="line">      &quot;expr&quot;: &quot;(builtins.getFlake \&quot;/home/lyc/flakes\&quot;).nixosConfigurations.adrastea.options&quot;</div>
<div class="line">    },</div>
<div class="line"> </div>
<div class="line">    // By default there is no home-manager options completion, thus you can add this entry.</div>
<div class="line">    &quot;home-manager&quot;: {</div>
<div class="line">      &quot;expr&quot;: &quot;(builtins.getFlake \&quot;/home/lyc/flakes\&quot;).homeConfigurations.\&quot;lyc@adrastea\&quot;.options&quot;</div>
<div class="line">    },</div>
<div class="line"> </div>
<div class="line">    // For flake-parts options.</div>
<div class="line">    // Firstly read the docs here to enable &quot;debugging&quot;, exposing declarations for nixd.</div>
<div class="line">    // https://flake.parts/debug</div>
<div class="line">    &quot;flake-parts&quot;: {</div>
<div class="line">      &quot;expr&quot;: &quot;(builtins.getFlake \&quot;/path/to/your/flake\&quot;).debug.options&quot;</div>
<div class="line">    },</div>
<div class="line">    // For a `perSystem` flake-parts option:</div>
<div class="line">    &quot;flake-parts2&quot;: {</div>
<div class="line">      &quot;expr&quot;: &quot;(builtins.getFlake \&quot;/path/to/your/flake\&quot;).currentSystem.options&quot;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p>If you aren't a flakes user with standalone home-manager with a vanilla install then the following expression should make home-manager options appear:</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;options&quot;: {</div>
<div class="line">    &quot;home-manager&quot;: {</div>
<div class="line">      &quot;expr&quot;: &quot;(import &lt;home-manager/modules&gt; { configuration = ~/.config/home-manager/home.nix; pkgs = import &lt;nixpkgs&gt; {}; }).options&quot;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="autotoc_md21"></a>
Q &amp; A</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md22"></a>
Home-manager options completion does not work. What is <span class="tt">homeConfigurations</span>?</h2>
<p>See configuration overview. If your home-manager is installed as part of a NixOS module, the options list can be retrieved like this:</p>
<div class="fragment"><div class="line">(builtins.getFlake (builtins.toString ./.)).nixosConfigurations.&lt;name&gt;.options.home-manager.users.type.getSubOptions []</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md23"></a>
Still not working?</h2>
<p>Try testing your expression in <span class="tt">nix repl</span>. This will help you diagnose evaluation issues. For example:</p>
<div class="fragment"><div class="line">nix-repl&gt; (builtins.getFlake (builtins.toString ./.)).nixosConfigurations.&lt;name&gt;.options</div>
<div class="line">error: syntax error, unexpected SPATH, expecting ID or OR_KW or DOLLAR_CURLY or &#39;&quot;&#39;</div>
<div class="line">  at «string»:1:65:</div>
<div class="line">       1| (builtins.getFlake (builtins.toString ./.)).nixosConfigurations.&lt;name&gt;.options</div>
<div class="line">        |                                                                 ^</div>
</div><!-- fragment --><p>Replace <span class="tt">&lt;name&gt;</span> with your actual configuration name:</p>
<div class="fragment"><div class="line">nix-repl&gt; (builtins.getFlake (builtins.toString ./.)).nixosConfigurations.adrastea.options</div>
<div class="line">{</div>
<div class="line">  _module = { ... };</div>
<div class="line">  appstream = { ... };</div>
<div class="line">  assertions = { ... };</div>
<div class="line">  boot = { ... };</div>
<div class="line">  # ... more options ..., this is expected.</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
